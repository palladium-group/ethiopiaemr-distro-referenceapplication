name: Build and Push Docker Images

on:
  push:
    branches: [main, rebuild-search-index]

jobs:
  build-backend-distro:
    name: Build Backend Distro
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      MAVEN_SETTINGS_XML: ${{ secrets.MAVEN_SETTINGS_XML }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"
          cache: "maven"

      - name: Write Maven settings (if provided)
        if: ${{ env.MAVEN_SETTINGS_XML != '' }}
        run: |
          cat > /tmp/maven-settings.xml <<'EOF'
          ${{ env.MAVEN_SETTINGS_XML }}
          EOF

      - name: Build distro to generate SPA configs
        run: |
          MVN_SETTINGS_ARG=""
          if [ -f /tmp/maven-settings.xml ]; then
            MVN_SETTINGS_ARG="-s /tmp/maven-settings.xml"
          fi
          mvn --batch-mode --update-snapshots --activate-profiles distro clean package -Dskip.validation=true $MVN_SETTINGS_ARG

      - name: Upload SPA configs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: spa-configs
          path: distro/target/sdk-distro/web/openmrs_spa/*
          retention-days: 1

  docker:
    name: Build and Push Images
    runs-on: ubuntu-latest
    needs: build-backend-distro
    permissions:
      contents: read
    env:
      IMAGE_NAMESPACE: ${{ secrets.DOCKERHUB_USERNAME }}
      PUSH_IMAGE: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/rebuild-search-index' && secrets.DOCKERHUB_USERNAME != '' && secrets.DOCKERHUB_TOKEN != '' }}
      MAVEN_SETTINGS_XML: ${{ secrets.MAVEN_SETTINGS_XML }}
    strategy:
      matrix:
        include:
          - service: backend
            context: .
            file: ./Dockerfile
          - service: frontend
            context: .
            file: ./frontend/Dockerfile
            needs-spa-configs: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Write Maven settings (if provided)
        if: ${{ env.MAVEN_SETTINGS_XML != '' }}
        run: |
          cat > /tmp/maven-settings.xml <<'EOF'
          ${{ env.MAVEN_SETTINGS_XML }}
          EOF

      - name: Download SPA configs (frontend only)
        if: ${{ matrix.needs-spa-configs }}
        uses: actions/download-artifact@v4
        with:
          name: spa-configs
          path: ./frontend/spa-configs

      - name: Ensure spa-configs directory exists
        if: ${{ matrix.needs-spa-configs }}
        run: |
          mkdir -p ./frontend/spa-configs

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: ${{ env.PUSH_IMAGE == 'true' }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.IMAGE_NAMESPACE }}/ethiopiaemr-${{ matrix.service }}
          tags: |
            type=raw,value=searchindex-build-test
            type=sha

      - name: Build and push ${{ matrix.service }}
        if: ${{ env.MAVEN_SETTINGS_XML != '' }}
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.file }}
          push: ${{ env.PUSH_IMAGE == 'true' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          no-cache: true
          secret-files: |
            m2settings=/tmp/maven-settings.xml

      - name: Build and push ${{ matrix.service }} (no Maven settings)
        if: ${{ env.MAVEN_SETTINGS_XML == '' }}
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.file }}
          push: ${{ env.PUSH_IMAGE == 'true' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          no-cache: true

  restart-ethioemr-deployment:
    name: Restart Ethioemr tenant deployments
    runs-on: ubuntu-latest
    needs: docker
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Restart deployments and submit search-index Job
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          password: ${{ secrets.VM_PASSWORD }}
          command_timeout: 2m
          script: |
            NAMESPACE="ethioemr-tenant-biftuhc"

            kubectl rollout restart deployment/biftuhc-frontend -n "$NAMESPACE"
            kubectl rollout restart deployment/biftuhc-backend  -n "$NAMESPACE"
            kubectl delete job search-index-init -n "$NAMESPACE" --ignore-not-found=true
            kubectl apply -f - <<'MANIFEST'
            apiVersion: batch/v1
            kind: Job
            metadata:
              name: search-index-init
              namespace: ethioemr-tenant-biftuhc
            spec:
              ttlSecondsAfterFinished: 600
              backoffLimit: 3
              template:
                spec:
                  restartPolicy: OnFailure
                  containers:
                    - name: search-index-init
                      image: curlimages/curl:latest
                      command: ["sh", "/scripts/rebuild-search-index.sh"]
                      env:
                        - name: OMRS_BASE_URL
                          value: "http://biftuhc-backend:8080/openmrs"
                        - name: OMRS_ADMIN_USER
                          valueFrom:
                            secretKeyRef:
                              name: ethioemr-openmrs-credentials
                              key: OMRS_ADMIN_USER
                        - name: OMRS_ADMIN_PASSWORD
                          valueFrom:
                            secretKeyRef:
                              name: ethioemr-openmrs-credentials
                              key: OMRS_ADMIN_PASSWORD
                      volumeMounts:
                        - name: script
                          mountPath: /scripts
                  volumes:
                    - name: script
                      configMap:
                        name: search-index-script
                        defaultMode: 0755
            MANIFEST
      - name: Wait for search-index Job and stream logs
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          password: ${{ secrets.VM_PASSWORD }}
          command_timeout: 35m
          script: |
            NAMESPACE="ethioemr-tenant-biftuhc"

            # Wait for the Job pod to be scheduled and running
            kubectl wait --for=condition=ready pod \
              -l job-name=search-index-init \
              -n "$NAMESPACE" \
              --timeout=300s

            # Stream logs â€” exits when the container finishes
            kubectl logs -f \
              -l job-name=search-index-init \
              -n "$NAMESPACE" \
              --container search-index-init

            # Final gate: fail this CI step if the Job did not complete successfully
            kubectl wait --for=condition=complete job/search-index-init \
              -n "$NAMESPACE" \
              --timeout=1800s